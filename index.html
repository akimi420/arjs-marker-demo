<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>AR.js Mini Golf Demo (Working Tilt Physics)</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    .hint {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 12px; background: rgba(0,0,0,.6); color: #fff;
      padding: 6px 10px; border-radius: 8px; font-size: 14px;
    }
    .message {
      position: fixed; top: 40%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 40px; font-weight: bold; color: #00ff80;
      display: none; text-shadow: 2px 2px 6px black;
    }
  </style>
</head>
<body>
  <a-scene embedded arjs="sourceType: webcam;" physics="debug: false;">
    <a-marker preset="hiro" id="marker">
      <!-- åºŠ -->
      <a-box id="floor" position="0 0 0" depth="4" height="0.1" width="4" color="#3FAF3F" static-body></a-box>

      <!-- å£ -->
      <a-box position="0 0.5 -2" depth="0.1" height="1" width="4" color="#2E8B57" static-body></a-box>
      <a-box position="0 0.5 2" depth="0.1" height="1" width="4" color="#2E8B57" static-body></a-box>
      <a-box position="-2 0.5 0" depth="4" height="1" width="0.1" color="#2E8B57" static-body></a-box>
      <a-box position="2 0.5 0" depth="4" height="1" width="0.1" color="#2E8B57" static-body></a-box>

      <!-- ç©´ -->
      <a-cylinder id="hole" position="1.2 0.05 1.2" radius="0.25" height="0.1" color="black" static-body></a-cylinder>

      <!-- ãƒœãƒ¼ãƒ« -->
      <a-sphere id="ball" position="0 0.8 0" radius="0.25" color="#EF2D5E" dynamic-body></a-sphere>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <div class="hint">ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ãƒœãƒ¼ãƒ«ã‚’è»¢ãŒãã†ï¼</div>
  <div class="message" id="message">ğŸ‰ Congratulations!! ğŸ‰</div>

  <script>
    let gx = 0, gz = 0;

    // ãƒ‡ãƒã‚¤ã‚¹ã®å‚¾ãã‚’å—ã‘å–ã£ã¦é‡åŠ›æ–¹å‘ã‚’æ›´æ–°
    window.addEventListener('deviceorientation', (event) => {
      const { beta, gamma } = event; // beta: å‰å¾Œ, gamma: å·¦å³
      gx = (gamma / 45) * 9.8;  // å‚¾ãã‚’å¼·ã‚ã«åæ˜ 
      gz = (beta / 45) * 9.8;
    });

    // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³æ›´æ–°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    AFRAME.registerComponent('gravity-updater', {
      tick: function () {
        const physics = this.el.systems.physics;
        if (!physics?.driver?.world) return;
        const world = physics.driver.world;

        // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ é‡åŠ›ãƒ™ã‚¯ãƒˆãƒ«ã‚’å†è¨­å®š
        world.gravity.set(gx, -9.8, gz);

        // æ‰‹å‹•ã§ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°ï¼ˆCannonã®å†…éƒ¨ã‚’å¼·åˆ¶é€²è¡Œï¼‰
        world.step(1 / 60);
      }
    });

    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
    AFRAME.registerComponent('goal-check', {
      tick: function () {
        const ball = document.querySelector('#ball');
        const hole = document.querySelector('#hole');
        const msg = document.querySelector('#message');
        if (!ball || !hole) return;

        const bPos = ball.object3D.position;
        const hPos = hole.object3D.position;
        const dist = bPos.distanceTo(hPos);

        if (dist < 0.25 && bPos.y < 0.3) {
          msg.style.display = 'block';
        }
      }
    });

    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é©ç”¨
    const scene = document.querySelector('a-scene');
    scene.setAttribute('gravity-updater', '');
    scene.setAttribute('goal-check', '');
  </script>
</body>
</html>
